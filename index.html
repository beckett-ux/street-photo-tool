<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Street Commerce Photo Tool</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #fff;
    }
    h1 {
      font-size: 32px;
      margin-bottom: 4px;
    }
    .subtitle {
      margin-bottom: 24px;
      color: #444;
    }
    .layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }
    .column {
      flex: 1;
      min-width: 320px;
    }
    .panel {
      background: #f8f8f8;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 12px;
    }

    /* Search bar */
    .search-row {
      margin-top: 8px;
      margin-bottom: 8px;
    }
    #search-input {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    #refresh-btn {
      margin-bottom: 12px;
    }

    #product-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .product-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
    }
    .product-main {
      flex: 1;
      min-width: 0;
    }
    .product-title {
      font-weight: 600;
      margin-bottom: 4px;
      word-break: break-word;
    }
    .product-meta {
      font-size: 12px;
      color: #666;
    }
    .product-empty {
      padding: 12px;
      color: #666;
      font-size: 14px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      background: #111827;
      color: #fff;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* Right side current product panel */
    #current-block {
      margin-bottom: 12px;
    }
    .current-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .current-meta {
      font-size: 13px;
      color: #555;
      margin-bottom: 16px;
    }
    .queue-text {
      margin-bottom: 16px;
      font-size: 13px;
    }
  </style>
</head>
<body>
  <h1>Street Commerce Photo Tool</h1>
  <div class="subtitle">
    This laptop should stay tethered to the camera saving files into the <strong>Watch</strong> folder.
  </div>

  <div class="layout">
    <!-- LEFT: products list -->
    <div class="column">
      <h2>Recent products without photos</h2>
      <div class="search-row">
        <input id="search-input" type="text" placeholder="Search products..." />
      </div>
      <button id="refresh-btn">Refresh list</button>

      <div id="product-list"></div>
    </div>

    <!-- RIGHT: current product -->
    <div class="column">
      <div class="panel">
        <h2>Current product</h2>
        <div id="current-block">
          <div class="current-title">None selected</div>
          <div class="current-meta"></div>
          <div class="queue-text">
            Queued photos this session: <span id="queue-count">0</span>
          </div>
        </div>
        <button id="done-btn">Done - upload photos and publish</button>
      </div>
    </div>
  </div>

  <script>
    const productListEl = document.getElementById('product-list');
    const refreshBtn = document.getElementById('refresh-btn');
    const doneBtn = document.getElementById('done-btn');
    const searchInputEl = document.getElementById('search-input');

    let allProducts = [];

    const currentTitleEl = document.querySelector('#current-block .current-title');
    const currentMetaEl = document.querySelector('#current-block .current-meta');
    const queueCountEl = document.getElementById('queue-count');

    function formatDate(iso) {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    function renderProductList(products) {
      productListEl.innerHTML = '';
      products.forEach(p => {
        const row = document.createElement('div');
        row.className = 'product-row';

        const main = document.createElement('div');
        main.className = 'product-main';

        const title = document.createElement('div');
        title.className = 'product-title';
        title.textContent = p.title;

        const meta = document.createElement('div');
        meta.className = 'product-meta';
        meta.textContent =
          `ID: ${p.id} | Status: ${p.status || 'unknown'} | Created: ${formatDate(p.created_at)}`;

        main.appendChild(title);
        main.appendChild(meta);

        const btn = document.createElement('button');
        btn.textContent = 'Select';
        btn.addEventListener('click', () => selectProduct(p));

        row.appendChild(main);
        row.appendChild(btn);

        productListEl.appendChild(row);
      });
    }

    function updateProductListFromSearch() {
      if (!allProducts.length) {
        productListEl.innerHTML =
          '<div class="product-empty">No recent products without photos found.</div>';
        return;
      }

      const term = searchInputEl ? searchInputEl.value.trim().toLowerCase() : '';
      const filtered = term
        ? allProducts.filter(p =>
            (p.title && p.title.toLowerCase().includes(term)) ||
            String(p.id).includes(term)
          )
        : allProducts;

      if (!filtered.length) {
        productListEl.innerHTML =
          '<div class="product-empty">No products match this search.</div>';
        return;
      }

      renderProductList(filtered);
    }

    async function loadProducts() {
      productListEl.innerHTML = '<div class="product-empty">Loading...</div>';
      try {
        const res = await fetch('/api/products-without-photos');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const products = await res.json();

        allProducts = products || [];

        if (!allProducts.length) {
          productListEl.innerHTML =
            '<div class="product-empty">No recent products without photos found.</div>';
          return;
        }

        updateProductListFromSearch();
      } catch (err) {
        console.error('loadProducts error', err);
        productListEl.innerHTML =
          '<div class="product-empty">Error loading products. Check the Node console.</div>';
      }
    }

    async function selectProduct(p) {
      try {
        await fetch('/api/select-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: p.id,
            title: p.title,
            created_at: p.created_at
          })
        });
        await loadCurrent(); // update right side immediately
      } catch (err) {
        console.error('selectProduct error', err);
        alert('Failed to select product');
      }
    }

    async function loadCurrent() {
      try {
        const res = await fetch('/api/current-product');
        if (!res.ok) return;
        const data = await res.json();

        if (!data.product) {
          currentTitleEl.textContent = 'None selected';
          currentMetaEl.textContent = '';
          queueCountEl.textContent = data.queuedCount || 0;
          return;
        }

        currentTitleEl.textContent = data.product.title;
        currentMetaEl.textContent =
          `ID: ${data.product.id} | Created: ${formatDate(data.product.created_at)}`;
        queueCountEl.textContent = data.queuedCount || 0;
      } catch (err) {
        console.error('loadCurrent error', err);
      }
    }

    async function doneUpload() {
      try {
        const res = await fetch('/api/done', { method: 'POST' });
        const json = await res.json();
        if (!res.ok) {
          alert(json.error || 'Upload failed');
          return;
        }
        alert('Uploaded and published. You can pick another product.');
        await loadProducts();
        await loadCurrent();
      } catch (err) {
        console.error('doneUpload error', err);
        alert('Error uploading images');
      }
    }

    refreshBtn.addEventListener('click', loadProducts);
    doneBtn.addEventListener('click', doneUpload);

    if (searchInputEl) {
      searchInputEl.addEventListener('input', updateProductListFromSearch);
    }

    // initial load plus poll current queue every few seconds
    window.addEventListener('load', () => {
      loadProducts();
      loadCurrent();
      setInterval(loadCurrent, 5000);
    });
  </script>
</body>
</html>
