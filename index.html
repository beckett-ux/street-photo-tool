<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Street Commerce Photo Tool</title>
  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #fff;
    }
    h1 {
      font-size: 32px;
      margin-bottom: 4px;
    }
    .subtitle {
      margin-bottom: 24px;
      color: #444;
    }
    .layout {
      display: flex;
      gap: 24px;
      align-items: flex-start;
    }
    .column {
      flex: 1;
      min-width: 320px;
    }
    .panel {
      background: #f8f8f8;
      border-radius: 8px;
      padding: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
    }
    h2 {
      margin-top: 0;
      font-size: 20px;
      margin-bottom: 12px;
    }

    /* Search bar */
    .search-row {
      margin-top: 8px;
      margin-bottom: 8px;
    }
    #search-input {
      width: 100%;
      padding: 6px 8px;
      font-size: 14px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }

    #refresh-btn {
      margin-bottom: 12px;
    }

    #product-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }
    .product-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      padding: 10px 12px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
    }
    .product-main {
      flex: 1;
      min-width: 0;
    }
    .product-title {
      font-weight: 600;
      margin-bottom: 4px;
      word-break: break-word;
    }
    .product-meta {
      font-size: 12px;
      color: #666;
    }
    .product-empty {
      padding: 12px;
      color: #666;
      font-size: 14px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 4px;
      padding: 8px 12px;
      font-size: 14px;
      background: #111827;
      color: #fff;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
    }

    /* Right side current product panel */
    #current-block {
      margin-bottom: 12px;
    }
    .current-title {
      font-weight: 600;
      margin-bottom: 4px;
    }
    .current-meta {
      font-size: 13px;
      color: #555;
      margin-bottom: 16px;
    }
    .queue-text {
      margin-bottom: 12px;
      font-size: 13px;
    }

    /* Queued photo previews */
    .previews-block {
      margin-bottom: 16px;
    }
    .previews-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 13px;
      color: #555;
      margin-bottom: 6px;
    }
    .previews-header span.label {
      font-weight: 600;
      color: #222;
    }
    .preview-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      max-height: 260px;
      overflow-y: auto;
    }
    .preview-item {
      position: relative;
      width: 90px;
      border-radius: 6px;
      border: 1px solid #ddd;
      background: #fff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: stretch;
    }
    .preview-thumb-wrapper {
      position: relative;
      width: 100%;
      padding-top: 100%; /* square */
      overflow: hidden;
    }
    .preview-thumb-wrapper img {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
    .preview-name {
      font-size: 11px;
      padding: 2px 4px 4px 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .preview-remove {
      position: absolute;
      top: 4px;
      right: 4px;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: none;
      background: rgba(0, 0, 0, 0.7);
      color: #fff;
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
    }
    .preview-empty {
      font-size: 12px;
      color: #777;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: #16a34a;
      color: #fff;
      padding: 10px 14px;
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.18);
      font-size: 14px;
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 1000;
    }
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <h1>Street Commerce Photo Tool</h1>
  <div class="subtitle">
    This laptop should stay tethered to the camera saving files into the <strong>Watch</strong> folder.
  </div>

  <!-- Toast notification -->
  <div id="toast" class="toast"></div>

  <div class="layout">
    <!-- LEFT: products list -->
    <div class="column">
      <h2>Recent products without photos</h2>
      <div class="search-row">
        <input id="search-input" type="text" placeholder="Search products..." />
      </div>
      <button id="refresh-btn">Refresh list</button>

      <div id="product-list"></div>
    </div>

    <!-- RIGHT: current product -->
    <div class="column">
      <div class="panel">
        <h2>Current product</h2>
        <div id="current-block">
          <div class="current-title">None selected</div>
          <div class="current-meta"></div>
          <div class="queue-text">
            Queued photos this session: <span id="queue-count">0</span>
          </div>
        </div>

        <!-- Queued photo previews -->
        <div class="previews-block">
          <div class="previews-header">
            <span class="label">Queued photos</span>
            <span id="preview-helper-text"></span>
          </div>
          <div id="preview-grid" class="preview-grid">
            <div class="preview-empty">No photos queued yet.</div>
          </div>
        </div>

        <button id="done-btn">Done - upload photos and publish</button>
      </div>
    </div>
  </div>

  <script>
    const productListEl = document.getElementById('product-list');
    const refreshBtn = document.getElementById('refresh-btn');
    const doneBtn = document.getElementById('done-btn');
    const searchInputEl = document.getElementById('search-input');
    const toastEl = document.getElementById('toast');
    const previewGridEl = document.getElementById('preview-grid');
    const previewHelperTextEl = document.getElementById('preview-helper-text');

    let allProducts = [];
    let toastTimeoutId = null;

    const currentTitleEl = document.querySelector('#current-block .current-title');
    const currentMetaEl = document.querySelector('#current-block .current-meta');
    const queueCountEl = document.getElementById('queue-count');

    function formatDate(iso) {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    function showToast(message) {
      if (!toastEl) return;
      toastEl.textContent = message;
      toastEl.classList.add('show');

      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
      }
      toastTimeoutId = setTimeout(() => {
        toastEl.classList.remove('show');
      }, 3500);
    }

    function renderProductList(products) {
      productListEl.innerHTML = '';
      products.forEach(p => {
        const row = document.createElement('div');
        row.className = 'product-row';

        const main = document.createElement('div');
        main.className = 'product-main';

        const title = document.createElement('div');
        title.className = 'product-title';
        title.textContent = p.title;

        const meta = document.createElement('div');
        meta.className = 'product-meta';
        meta.textContent =
          `ID: ${p.id} | Status: ${p.status || 'unknown'} | Created: ${formatDate(p.created_at)}`;

        main.appendChild(title);
        main.appendChild(meta);

        const btn = document.createElement('button');
        btn.textContent = 'Select';
        btn.addEventListener('click', () => selectProduct(p));

        row.appendChild(main);
        row.appendChild(btn);

        productListEl.appendChild(row);
      });
    }

    function updateProductListFromSearch() {
      if (!allProducts.length) {
        productListEl.innerHTML =
          '<div class="product-empty">No recent products without photos found.</div>';
        return;
      }

      const term = searchInputEl ? searchInputEl.value.trim().toLowerCase() : '';
      const filtered = term
        ? allProducts.filter(p =>
            (p.title && p.title.toLowerCase().includes(term)) ||
            String(p.id).includes(term)
          )
        : allProducts;

      if (!filtered.length) {
        productListEl.innerHTML =
          '<div class="product-empty">No products match this search.</div>';
        return;
      }

      renderProductList(filtered);
    }

    async function loadProducts() {
      productListEl.innerHTML = '<div class="product-empty">Loading...</div>';
      try {
        const res = await fetch('/api/products-without-photos');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const products = await res.json();

        allProducts = products || [];

        if (!allProducts.length) {
          productListEl.innerHTML =
            '<div class="product-empty">No recent products without photos found.</div>';
          return;
        }

        updateProductListFromSearch();
      } catch (err) {
        console.error('loadProducts error', err);
        productListEl.innerHTML =
          '<div class="product-empty">Error loading products. Check the Node console.</div>';
      }
    }

    function renderQueuedPhotos(photos) {
      if (!previewGridEl) return;

      if (!photos || !photos.length) {
        previewGridEl.innerHTML = '<div class="preview-empty">No photos queued yet.</div>';
        if (previewHelperTextEl) {
          previewHelperTextEl.textContent = '';
        }
        return;
      }

      previewGridEl.innerHTML = '';
      photos.forEach(photo => {
        const item = document.createElement('div');
        item.className = 'preview-item';

        const thumbWrap = document.createElement('div');
        thumbWrap.className = 'preview-thumb-wrapper';

        const img = document.createElement('img');
        img.src = photo.url;
        img.alt = photo.name || 'Queued photo';

        const removeBtn = document.createElement('button');
        removeBtn.className = 'preview-remove';
        removeBtn.textContent = 'Ã—';
        removeBtn.title = 'Remove photo';
        removeBtn.addEventListener('click', () => {
          if (photo.relPath) {
            removeQueuedPhoto(photo.relPath);
          }
        });

        thumbWrap.appendChild(img);
        thumbWrap.appendChild(removeBtn);

        const nameEl = document.createElement('div');
        nameEl.className = 'preview-name';
        nameEl.textContent = photo.name || '';

        item.appendChild(thumbWrap);
        item.appendChild(nameEl);

        previewGridEl.appendChild(item);
      });

      if (previewHelperTextEl) {
        previewHelperTextEl.textContent = photos.length + ' photo' + (photos.length === 1 ? '' : 's');
      }
    }

    async function loadQueuedPhotos() {
      try {
        const res = await fetch('/api/queued-photos');
        if (!res.ok) {
          return;
        }
        const data = await res.json();
        const photos = data && Array.isArray(data.photos) ? data.photos : [];
        renderQueuedPhotos(photos);
      } catch (err) {
        console.error('loadQueuedPhotos error', err);
      }
    }

    async function selectProduct(p) {
      try {
        await fetch('/api/select-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: p.id,
            title: p.title,
            created_at: p.created_at
          })
        });
        await loadCurrent();
        await loadQueuedPhotos();
      } catch (err) {
        console.error('selectProduct error', err);
        alert('Failed to select product');
      }
    }

    async function loadCurrent() {
      try {
        const res = await fetch('/api/current-product');
        if (!res.ok) return;
        const data = await res.json();

        if (!data.product) {
          currentTitleEl.textContent = 'None selected';
          currentMetaEl.textContent = '';
          queueCountEl.textContent = data.queuedCount || 0;
          return;
        }

        currentTitleEl.textContent = data.product.title;
        currentMetaEl.textContent =
          `ID: ${data.product.id} | Created: ${formatDate(data.product.created_at)}`;
        queueCountEl.textContent = data.queuedCount || 0;
      } catch (err) {
        console.error('loadCurrent error', err);
      }
    }

    async function removeQueuedPhoto(relPath) {
      try {
        const res = await fetch('/api/remove-photo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ relPath })
        });
        const json = await res.json();
        if (!res.ok) {
          const msg = json.error || 'Failed to remove photo';
          alert(msg);
          return;
        }
        await loadQueuedPhotos();
        await loadCurrent();
      } catch (err) {
        console.error('removeQueuedPhoto error', err);
        alert('Error removing photo');
      }
    }

    async function doneUpload() {
      try {
        const res = await fetch('/api/done', { method: 'POST' });
        const json = await res.json();
        if (!res.ok) {
          const msg = json.error || 'Upload failed';
          alert(msg);
          return;
        }

        // Clear the search field so the full list shows again
        if (searchInputEl) {
          searchInputEl.value = '';
        }

        // Show green success popup
        showToast('Photos uploaded and product published. Ready for the next product.');

        await loadProducts();
        await loadCurrent();
        await loadQueuedPhotos();
      } catch (err) {
        console.error('doneUpload error', err);
        alert('Error uploading images');
      }
    }

    refreshBtn.addEventListener('click', loadProducts);
    doneBtn.addEventListener('click', doneUpload);

    if (searchInputEl) {
      searchInputEl.addEventListener('input', updateProductListFromSearch);
    }

    // initial load plus poll current queue and previews every few seconds
    window.addEventListener('load', () => {
      loadProducts();
      loadCurrent();
      loadQueuedPhotos();
      setInterval(() => {
        loadCurrent();
        loadQueuedPhotos();
      }, 5000);
    });
  </script>
</body>
</html>
