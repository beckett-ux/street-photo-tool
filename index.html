<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Street Commerce Photo Tool</title>
  <style>
    :root {
      color-scheme: light;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #ffffff;
      color: #111827;
    }

    .page {
      max-width: 1240px;
      margin: 0 auto;
      position: relative;
    }

    .logo-wrap {
      text-align: center;
      margin-bottom: 8px;
    }

    .logo-img {
      max-width: 200px;
      height: auto;
    }

    h1 {
      font-size: 28px;
      margin: 8px 0 4px 0;
      text-align: center;
      color: #111827;
    }

    .subtitle {
      margin-bottom: 20px;
      color: #4b5563;
      font-size: 14px;
      text-align: center;
    }

    .layout {
      display: flex;
      gap: 20px;
      align-items: stretch;
    }

    .column {
      min-width: 320px;
    }

    .column-left {
      flex: 0.55;
    }

    .column-right {
      flex: 0.45;
    }

    .panel {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.16);
      border: 1px solid #e5e7eb;
      box-sizing: border-box;
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 10px;
      color: #111827;
    }

    /* Search row */
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    #search-input {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      box-sizing: border-box;
      outline: none;
      background: #f3f4f6;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    #search-input:focus {
      border-color: #0f766e;
      box-shadow: 0 0 0 1px #0f766e33;
      background: #ffffff;
    }

    #refresh-btn {
      flex-shrink: 0;
    }

    #product-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .product-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      box-sizing: border-box;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease;
    }

    .product-row:hover {
      border-color: #0f766e;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
    }

    .product-main {
      flex: 1;
      min-width: 0;
    }

    .product-title {
      font-weight: 600;
      margin-bottom: 2px;
      word-break: break-word;
      font-size: 14px;
      color: #111827;
    }

    .product-meta {
      font-size: 11px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-empty {
      padding: 12px;
      color: #6b7280;
      font-size: 13px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 500;
      background: #111827;
      color: #fff;
      transition: background 0.12s ease, transform 0.06s ease, box-shadow 0.12s ease;
      white-space: nowrap;
    }

    button:hover:not(:disabled) {
      background: #020617;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      transform: translateY(-0.5px);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.25);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    .close-btn {
      position: absolute;
      top: 14px;
      right: 14px;
      padding: 6px 12px;
      font-size: 12px;
      background: #dc2626;
    }

    .close-btn:hover:not(:disabled) {
      background: #b91c1c;
    }

    /* Store splash */
    .splash-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.6);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
    }

    .splash-modal {
      background: #ffffff;
      border-radius: 16px;
      padding: 24px 28px;
      max-width: 420px;
      width: 90%;
      box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
      text-align: center;
      border: 1px solid #e5e7eb;
    }

    .splash-title {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 8px;
      color: #111827;
    }

    .splash-subtitle {
      font-size: 14px;
      color: #4b5563;
      margin-bottom: 20px;
    }

    .splash-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 10px;
    }

    .splash-btn {
      width: 100%;
      font-size: 16px;
      padding: 14px 18px;
    }

    .splash-link {
      background: none;
      border-radius: 0;
      box-shadow: none;
      padding: 0;
      font-size: 13px;
      color: #0f766e;
      text-decoration: underline;
    }

    .splash-link:hover:not(:disabled) {
      background: none;
      box-shadow: none;
      transform: none;
      color: #115e59;
    }

    /* Right side current product panel */
    #current-block {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .current-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 16px;
      color: #111827;
    }

    .current-meta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .queue-text {
      margin-bottom: 4px;
      font-size: 12px;
      color: #4b5563;
    }

    /* Queued photo previews */
    .previews-block {
      margin-bottom: 16px;
    }

    .previews-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .previews-header span.label {
      font-weight: 600;
      color: #111827;
      font-size: 13px;
    }

    .preview-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .preview-item {
      position: relative;
      width: 240px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
      box-sizing: border-box;
      cursor: grab;
      transition: box-shadow 0.12s ease, transform 0.12s ease, border-color 0.12s ease;
    }

    .preview-item.dragging {
      opacity: 0.9;
      border-color: #0f766e;
      box-shadow: 0 6px 14px rgba(15, 23, 42, 0.24);
      transform: scale(1.02);
      cursor: grabbing;
    }

    .preview-item.drag-over {
      border-color: #0f766e;
      box-shadow: 0 0 0 2px #0f766e55;
    }

    .preview-thumb-wrapper {
      position: relative;
      width: 100%;
      height: 190px;
      overflow: hidden;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-thumb-wrapper img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain;
      display: block;
    }

    .preview-name {
      font-size: 11px;
      padding: 4px 8px 6px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #4b5563;
      background: #f9fafb;
    }

    .preview-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      background: rgba(15, 23, 42, 0.85);
      color: #fff;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.4);
    }

    .preview-remove:hover {
      background: rgba(15, 23, 42, 1);
    }

    .preview-empty {
      font-size: 12px;
      color: #6b7280;
    }

    /* Done button area */
    #done-btn {
      width: 100%;
      margin-top: 6px;
      padding: 10px 14px;
      font-size: 14px;
      background: #0f766e;
    }

    #done-btn:hover:not(:disabled) {
      background: #115e59;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 32px;
      left: 50%;
      transform: translate(-50%, 12px);
      background: #16a34a;
      color: #fff;
      padding: 14px 20px;
      border-radius: 999px;
      box-shadow: 0 8px 30px rgba(0, 0, 0, 0.35);
      font-size: 15px;
      font-weight: 600;
      opacity: 0;
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 1000;
      text-align: center;
      min-width: 260px;
    }

    .toast.show {
      opacity: 1;
      transform: translate(-50%, 0);
    }

    .footer {
      margin-top: 24px;
      text-align: center;
      font-size: 12px;
      color: #9ca3af;
    }
  </style>
</head>
<body>
  <!-- Store selection splash (first load per session) -->
  <div id="store-splash" class="splash-backdrop">
    <div class="splash-modal">
      <div class="splash-title">Choose your store</div>
      <div class="splash-subtitle">
        Pick the location for this session so we only show products for that store.
      </div>
      <div class="splash-buttons">
        <button type="button" class="splash-btn" data-store="DMV">
          DC Store
        </button>
        <button type="button" class="splash-btn" data-store="CLT">
          Charlotte Store
        </button>
      </div>
      <button type="button" class="splash-link" data-store="ALL">
        Show all items
      </button>
    </div>
  </div>

  <div class="page">
    <button id="close-btn" class="close-btn">Close</button>

    <div class="logo-wrap">
      <img
        src="https://streetcommerce.shop/cdn/shop/files/64b7cc5bd29c585c54174034_back_graphic_copy2-p-500.png?v=1709318626&width=200"
        alt="Street Commerce logo"
        class="logo-img"
      />
    </div>

    <h1>Street Commerce Photo Tool</h1>
    <div class="subtitle">
      This laptop should stay tethered to the camera saving files into the <strong>Watch</strong> folder.
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <div class="layout">
      <!-- LEFT: products list -->
      <div class="column column-left">
        <div class="panel">
          <h2>Recent products without photos</h2>
          <div class="search-row">
            <input id="search-input" type="text" placeholder="Search by title, SKU, or id" />
            <button id="refresh-btn">Refresh</button>
          </div>
          <div id="product-list"></div>
        </div>
      </div>

      <!-- RIGHT: current product and previews -->
      <div class="column column-right">
        <div class="panel">
          <h2>Current product</h2>
          <div id="current-block">
            <div class="current-title">None selected</div>
            <div class="current-meta"></div>
            <div class="queue-text">
              Queued photos this session: <span id="queue-count">0</span>
            </div>
          </div>

          <!-- Queued photo previews -->
          <div class="previews-block">
            <div class="previews-header">
              <span class="label">Queued photos</span>
              <span id="preview-helper-text"></span>
            </div>
            <div id="preview-grid" class="preview-grid">
              <div class="preview-empty">No photos queued yet.</div>
            </div>
          </div>

          <button id="done-btn">Done - upload photos and publish</button>
        </div>
      </div>
    </div>

    <div class="footer">
      Beta Version V1.0 by Beckett.
    </div>
  </div>

  <script>
    const productListEl = document.getElementById('product-list');
    const refreshBtn = document.getElementById('refresh-btn');
    const doneBtn = document.getElementById('done-btn');
    const searchInputEl = document.getElementById('search-input');
    const toastEl = document.getElementById('toast');
    const previewGridEl = document.getElementById('preview-grid');
    const previewHelperTextEl = document.getElementById('preview-helper-text');
    const closeBtn = document.getElementById('close-btn');

    const splashEl = document.getElementById('store-splash');
    const splashStoreButtons = document.querySelectorAll('[data-store]');

    let allProducts = [];
    let toastTimeoutId = null;

    const currentTitleEl = document.querySelector('#current-block .current-title');
    const currentMetaEl = document.querySelector('#current-block .current-meta');
    const queueCountEl = document.getElementById('queue-count');

    // Store selection
    let selectedStore = null; // DMV, CLT, or ALL
    let appStarted = false;

    // Drag and drop ordering
    let queuedPhotos = [];
    let dragSrcIndex = null;

    // Upload button animation
    const doneBtnDefaultText = doneBtn ? doneBtn.textContent : 'Done - upload photos and publish';
    let uploading = false;
    let uploadDotsInterval = null;

    function setUploadingState(isUploading) {
      if (!doneBtn) return;

      if (isUploading) {
        uploading = true;
        doneBtn.disabled = true;

        const base = 'Uploading';
        let dots = 1;
        doneBtn.textContent = base + '.';

        if (uploadDotsInterval) {
          clearInterval(uploadDotsInterval);
        }

        uploadDotsInterval = setInterval(() => {
          dots = dots + 1;
          if (dots > 3) dots = 1;
          doneBtn.textContent = base + '.'.repeat(dots);
        }, 400);
      } else {
        uploading = false;
        doneBtn.disabled = false;

        if (uploadDotsInterval) {
          clearInterval(uploadDotsInterval);
          uploadDotsInterval = null;
        }
        doneBtn.textContent = doneBtnDefaultText;
      }
    }

    function formatDate(iso) {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    function showToast(message) {
      if (!toastEl) return;
      toastEl.textContent = message;
      toastEl.classList.add('show');

      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
      }
      toastTimeoutId = setTimeout(() => {
        toastEl.classList.remove('show');
      }, 3500);
    }

    function renderProductList(products) {
      productListEl.innerHT
