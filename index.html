<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Street Commerce Photo Tool</title>
  <style>
    :root {
      color-scheme: light;
    }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 24px;
      background: #0f172a;
      color: #0f172a;
    }

    .page {
      max-width: 1240px;
      margin: 0 auto;
    }

    h1 {
      font-size: 28px;
      margin: 0 0 4px 0;
      color: #f9fafb;
    }

    .subtitle {
      margin-bottom: 20px;
      color: #9ca3af;
      font-size: 14px;
    }

    .layout {
      display: flex;
      gap: 20px;
      align-items: stretch;
    }

    .column {
      min-width: 320px;
    }

    .column-left {
      flex: 0.55;
    }

    .column-right {
      flex: 0.45;
    }

    .panel {
      background: #f9fafb;
      border-radius: 12px;
      padding: 16px 18px;
      box-shadow: 0 10px 25px rgba(15, 23, 42, 0.16);
      border: 1px solid #e5e7eb;
      box-sizing: border-box;
    }

    h2 {
      margin-top: 0;
      font-size: 18px;
      margin-bottom: 10px;
      color: #111827;
    }

    /* Search row */
    .search-row {
      display: flex;
      gap: 8px;
      margin-bottom: 10px;
    }

    #search-input {
      width: 100%;
      padding: 8px 10px;
      font-size: 14px;
      border: 1px solid #d1d5db;
      border-radius: 999px;
      box-sizing: border-box;
      outline: none;
      background: #f3f4f6;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background 0.15s ease;
    }

    #search-input:focus {
      border-color: #0f766e;
      box-shadow: 0 0 0 1px #0f766e33;
      background: #ffffff;
    }

    #refresh-btn {
      flex-shrink: 0;
    }

    #product-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
      max-height: 520px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .product-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 8px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      box-sizing: border-box;
      transition: border-color 0.12s ease, box-shadow 0.12s ease, transform 0.08s ease;
    }

    .product-row:hover {
      border-color: #0f766e;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.08);
      transform: translateY(-1px);
    }

    .product-main {
      flex: 1;
      min-width: 0;
    }

    .product-title {
      font-weight: 600;
      margin-bottom: 2px;
      word-break: break-word;
      font-size: 14px;
      color: #111827;
    }

    .product-meta {
      font-size: 11px;
      color: #6b7280;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .product-empty {
      padding: 12px;
      color: #6b7280;
      font-size: 13px;
    }

    button {
      cursor: pointer;
      border: none;
      border-radius: 999px;
      padding: 7px 14px;
      font-size: 13px;
      font-weight: 500;
      background: #111827;
      color: #fff;
      transition: background 0.12s ease, transform 0.06s ease, box-shadow 0.12s ease;
      white-space: nowrap;
    }

    button:hover:not(:disabled) {
      background: #020617;
      box-shadow: 0 4px 10px rgba(15, 23, 42, 0.25);
      transform: translateY(-0.5px);
    }

    button:active:not(:disabled) {
      transform: translateY(0);
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.25);
    }

    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    /* Right side current product panel */
    #current-block {
      margin-bottom: 10px;
      padding-bottom: 10px;
      border-bottom: 1px solid #e5e7eb;
    }

    .current-title {
      font-weight: 600;
      margin-bottom: 4px;
      font-size: 16px;
      color: #111827;
    }

    .current-meta {
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 10px;
    }

    .queue-text {
      margin-bottom: 4px;
      font-size: 12px;
      color: #4b5563;
    }

    /* Queued photo previews */
    .previews-block {
      margin-bottom: 16px;
    }

    .previews-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      font-size: 12px;
      color: #6b7280;
      margin-bottom: 8px;
    }

    .previews-header span.label {
      font-weight: 600;
      color: #111827;
      font-size: 13px;
    }

    .preview-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      max-height: 420px;
      overflow-y: auto;
      padding-right: 4px;
    }

    .preview-item {
      position: relative;
      width: 240px;
      border-radius: 10px;
      border: 1px solid #e5e7eb;
      background: #ffffff;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      align-items: stretch;
      box-shadow: 0 3px 8px rgba(15, 23, 42, 0.08);
      box-sizing: border-box;
      cursor: grab;
    }

    .preview-item.dragging {
      opacity: 0.85;
      outline: 2px dashed #0f766e;
      outline-offset: -2px;
      cursor: grabbing;
    }

    .preview-thumb-wrapper {
      position: relative;
      width: 100%;
      height: 190px; /* larger, fixed height */
      overflow: hidden;
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .preview-thumb-wrapper img {
      max-width: 100%;
      max-height: 100%;
      width: auto;
      height: auto;
      object-fit: contain; /* no cropping, full image in box */
      display: block;
    }

    .preview-name {
      font-size: 11px;
      padding: 4px 8px 6px 8px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #4b5563;
      background: #f9fafb;
    }

    .preview-remove {
      position: absolute;
      top: 6px;
      right: 6px;
      width: 22px;
      height: 22px;
      border-radius: 999px;
      border: none;
      background: rgba(15, 23, 42, 0.85);
      color: #fff;
      font-size: 13px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      padding: 0;
      box-shadow: 0 1px 4px rgba(15, 23, 42, 0.4);
    }

    .preview-remove:hover {
      background: rgba(15, 23, 42, 1);
    }

    .preview-empty {
      font-size: 12px;
      color: #6b7280;
    }

    /* Done button area */
    #done-btn {
      width: 100%;
      margin-top: 6px;
      padding: 10px 14px;
      font-size: 14px;
      background: #0f766e;
    }

    #done-btn:hover:not(:disabled) {
      background: #115e59;
    }

    /* Toast notification */
    .toast {
      position: fixed;
      bottom: 16px;
      right: 16px;
      background: #16a34a;
      color: #fff;
      padding: 10px 14px;
      border-radius: 8px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.35);
      font-size: 14px;
      opacity: 0;
      transform: translateY(8px);
      pointer-events: none;
      transition: opacity 0.2s ease, transform 0.2s ease;
      z-index: 1000;
    }

    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
  </style>
</head>
<body>
  <div class="page">
    <h1>Street Commerce Photo Tool</h1>
    <div class="subtitle">
      This laptop should stay tethered to the camera saving files into the <strong>Watch</strong> folder.
    </div>

    <!-- Toast notification -->
    <div id="toast" class="toast"></div>

    <div class="layout">
      <!-- LEFT: products list -->
      <div class="column column-left">
        <div class="panel">
          <h2>Recent products without photos</h2>
          <div class="search-row">
            <input id="search-input" type="text" placeholder="Search by title or id" />
            <button id="refresh-btn">Refresh</button>
          </div>
          <div id="product-list"></div>
        </div>
      </div>

      <!-- RIGHT: current product and previews -->
      <div class="column column-right">
        <div class="panel">
          <h2>Current product</h2>
          <div id="current-block">
            <div class="current-title">None selected</div>
            <div class="current-meta"></div>
            <div class="queue-text">
              Queued photos this session: <span id="queue-count">0</span>
            </div>
          </div>

          <!-- Queued photo previews -->
          <div class="previews-block">
            <div class="previews-header">
              <span class="label">Queued photos</span>
              <span id="preview-helper-text"></span>
            </div>
            <div id="preview-grid" class="preview-grid">
              <div class="preview-empty">No photos queued yet.</div>
            </div>
          </div>

          <button id="done-btn">Done - upload photos and publish</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    const productListEl = document.getElementById('product-list');
    const refreshBtn = document.getElementById('refresh-btn');
    const doneBtn = document.getElementById('done-btn');
    const searchInputEl = document.getElementById('search-input');
    const toastEl = document.getElementById('toast');
    const previewGridEl = document.getElementById('preview-grid');
    const previewHelperTextEl = document.getElementById('preview-helper-text');

    let allProducts = [];
    let toastTimeoutId = null;

    const currentTitleEl = document.querySelector('#current-block .current-title');
    const currentMetaEl = document.querySelector('#current-block .current-meta');
    const queueCountEl = document.getElementById('queue-count');

    // For drag and drop ordering
    let queuedPhotos = [];
    let dragSrcIndex = null;

    function formatDate(iso) {
      if (!iso) return '';
      try {
        const d = new Date(iso);
        return d.toLocaleString();
      } catch {
        return iso;
      }
    }

    function showToast(message) {
      if (!toastEl) return;
      toastEl.textContent = message;
      toastEl.classList.add('show');

      if (toastTimeoutId) {
        clearTimeout(toastTimeoutId);
      }
      toastTimeoutId = setTimeout(() => {
        toastEl.classList.remove('show');
      }, 3500);
    }

    function renderProductList(products) {
      productListEl.innerHTML = '';
      products.forEach(p => {
        const row = document.createElement('div');
        row.className = 'product-row';

        const main = document.createElement('div');
        main.className = 'product-main';

        const title = document.createElement('div');
        title.className = 'product-title';
        title.textContent = p.title;

        const meta = document.createElement('div');
        meta.className = 'product-meta';
        meta.textContent =
          `ID: ${p.id} | Status: ${p.status || 'unknown'} | Created: ${formatDate(p.created_at)}`;

        main.appendChild(title);
        main.appendChild(meta);

        const btn = document.createElement('button');
        btn.textContent = 'Select';
        btn.addEventListener('click', () => selectProduct(p));

        row.appendChild(main);
        row.appendChild(btn);

        productListEl.appendChild(row);
      });
    }

    function updateProductListFromSearch() {
      if (!allProducts.length) {
        productListEl.innerHTML =
          '<div class="product-empty">No recent products without photos found.</div>';
        return;
      }

      const term = searchInputEl ? searchInputEl.value.trim().toLowerCase() : '';
      const filtered = term
        ? allProducts.filter(p =>
            (p.title && p.title.toLowerCase().includes(term)) ||
            String(p.id).includes(term)
          )
        : allProducts;

      if (!filtered.length) {
        productListEl.innerHTML =
          '<div class="product-empty">No products match this search.</div>';
        return;
      }

      renderProductList(filtered);
    }

    async function loadProducts() {
      productListEl.innerHTML = '<div class="product-empty">Loading...</div>';
      try {
        const res = await fetch('/api/products-without-photos');
        if (!res.ok) throw new Error('HTTP ' + res.status);
        const products = await res.json();

        allProducts = products || [];

        if (!allProducts.length) {
          productListEl.innerHTML =
            '<div class="product-empty">No recent products without photos found.</div>';
          return;
        }

        updateProductListFromSearch();
      } catch (err) {
        console.error('loadProducts error', err);
        productListEl.innerHTML =
          '<div class="product-empty">Error loading products. Check the Node console.</div>';
      }
    }

    function attachDragHandlers(item, index) {
      item.draggable = true;
      item.dataset.index = String(index);

      item.addEventListener('dragstart', handlePreviewDragStart);
      item.addEventListener('dragover', handlePreviewDragOver);
      item.addEventListener('drop', handlePreviewDrop);
      item.addEventListener('dragend', handlePreviewDragEnd);
    }

    function handlePreviewDragStart(e) {
      const idx = Number(this.dataset.index);
      dragSrcIndex = isNaN(idx) ? null : idx;
      this.classList.add('dragging');
      if (e.dataTransfer) {
        e.dataTransfer.effectAllowed = 'move';
        e.dataTransfer.setData('text/plain', '');
      }
    }

    function handlePreviewDragOver(e) {
      e.preventDefault();
      if (e.dataTransfer) {
        e.dataTransfer.dropEffect = 'move';
      }
    }

    function handlePreviewDrop(e) {
      e.preventDefault();
      const targetIdx = Number(this.dataset.index);
      if (dragSrcIndex === null || isNaN(targetIdx) || dragSrcIndex === targetIdx) {
        return;
      }

      const updated = [...queuedPhotos];
      const [moved] = updated.splice(dragSrcIndex, 1);
      updated.splice(targetIdx, 0, moved);
      queuedPhotos = updated;

      sendReorderToServer();
      renderQueuedPhotos(queuedPhotos);
    }

    function handlePreviewDragEnd() {
      this.classList.remove('dragging');
      dragSrcIndex = null;
    }

    function renderQueuedPhotos(photos) {
      if (!previewGridEl) return;

      if (!photos || !photos.length) {
        queuedPhotos = [];
        previewGridEl.innerHTML = '<div class="preview-empty">No photos queued yet.</div>';
        if (previewHelperTextEl) {
          previewHelperTextEl.textContent = '';
        }
        return;
      }

      queuedPhotos = photos.slice();

      previewGridEl.innerHTML = '';
      queuedPhotos.forEach((photo, index) => {
        const item = document.createElement('div');
        item.className = 'preview-item';

        const thumbWrap = document.createElement('div');
        thumbWrap.className = 'preview-thumb-wrapper';

        const img = document.createElement('img');
        img.src = photo.url;
        img.alt = photo.name || 'Queued photo';

        const removeBtn = document.createElement('button');
        removeBtn.className = 'preview-remove';
        removeBtn.textContent = 'Ã—';
        removeBtn.title = 'Remove photo';
        removeBtn.addEventListener('click', (event) => {
          event.stopPropagation();
          if (photo.relPath) {
            removeQueuedPhoto(photo.relPath);
          }
        });

        thumbWrap.appendChild(img);
        thumbWrap.appendChild(removeBtn);

        const nameEl = document.createElement('div');
        nameEl.className = 'preview-name';
        nameEl.textContent = photo.name || '';

        item.appendChild(thumbWrap);
        item.appendChild(nameEl);

        attachDragHandlers(item, index);

        previewGridEl.appendChild(item);
      });

      if (previewHelperTextEl) {
        previewHelperTextEl.textContent = queuedPhotos.length + ' photo' + (queuedPhotos.length === 1 ? '' : 's');
      }
    }

    async function loadQueuedPhotos() {
      try {
        const res = await fetch('/api/queued-photos');
        if (!res.ok) {
          return;
        }
        const data = await res.json();
        const photos = data && Array.isArray(data.photos) ? data.photos : [];
        renderQueuedPhotos(photos);
      } catch (err) {
        console.error('loadQueuedPhotos error', err);
      }
    }

    async function sendReorderToServer() {
      try {
        const order = queuedPhotos
          .map(p => p.relPath)
          .filter(Boolean);

        if (!order.length) return;

        const res = await fetch('/api/reorder-photos', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ order })
        });

        if (!res.ok) {
          const text = await res.text();
          console.error('sendReorderToServer error', text);
        }
      } catch (err) {
        console.error('sendReorderToServer error', err);
      }
    }

    async function selectProduct(p) {
      try {
        await fetch('/api/select-product', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            id: p.id,
            title: p.title,
            created_at: p.created_at
          })
        });
        await loadCurrent();
        await loadQueuedPhotos();
      } catch (err) {
        console.error('selectProduct error', err);
        alert('Failed to select product');
      }
    }

    async function loadCurrent() {
      try {
        const res = await fetch('/api/current-product');
        if (!res.ok) return;
        const data = await res.json();

        if (!data.product) {
          currentTitleEl.textContent = 'None selected';
          currentMetaEl.textContent = '';
          queueCountEl.textContent = data.queuedCount || 0;
          return;
        }

        currentTitleEl.textContent = data.product.title;
        currentMetaEl.textContent =
          `ID: ${data.product.id} | Created: ${formatDate(data.product.created_at)}`;
        queueCountEl.textContent = data.queuedCount || 0;
      } catch (err) {
        console.error('loadCurrent error', err);
      }
    }

    async function removeQueuedPhoto(relPath) {
      try {
        const res = await fetch('/api/remove-photo', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ relPath })
        });
        const json = await res.json();
        if (!res.ok) {
          const msg = json.error || 'Failed to remove photo';
          alert(msg);
          return;
        }
        await loadQueuedPhotos();
        await loadCurrent();
      } catch (err) {
        console.error('removeQueuedPhoto error', err);
        alert('Error removing photo');
      }
    }

    async function doneUpload() {
      try {
        const res = await fetch('/api/done', { method: 'POST' });
        const json = await res.json();
        if (!res.ok) {
          const msg = json.error || 'Upload failed';
          alert(msg);
          return;
        }

        if (searchInputEl) {
          searchInputEl.value = '';
        }

        showToast('Photos uploaded and product published. Ready for the next product.');

        await loadProducts();
        await loadCurrent();
        await loadQueuedPhotos();
      } catch (err) {
        console.error('doneUpload error', err);
        alert('Error uploading images');
      }
    }

    refreshBtn.addEventListener('click', loadProducts);
    doneBtn.addEventListener('click', doneUpload);

    if (searchInputEl) {
      searchInputEl.addEventListener('input', updateProductListFromSearch);
    }

    window.addEventListener('load', () => {
      loadProducts();
      loadCurrent();
      loadQueuedPhotos();
      setInterval(() => {
        loadCurrent();
        loadQueuedPhotos();
      }, 5000);
    });
  </script>
</body>
</html>
